# ElderSpy

## Usage
### Requirements
- Docker
- JDK 17
- Maven 3.9.6
- Kubernetes environment (optional)

### Running the project
1. Clone the repository
2. Build and start the backend containers
```shell
~/backend $ docker-compose up --build -d
```
3. Build and start the edge containers
```shell
~/gateway $ docker-compose up --build -d
```
4. Build and start the sensor container
```shell
~/sensors $ docker build -t elderspy-temp-sensor .
~/sensors $ docker run -d elderspy-temp-sensor
```
(optional) Kubernetes deployment 
```shell
~/backend/kubernetes $ kubectl apply -f ./namespace -f ./config-maps -f ./deployments -f ./services -f ./secrets -f ./hpa -n elderspy-ns
```
Accessing the following services:

InfluxDB UI:
```
http://localhost:8086/

username: admin
password: admin123
```
Grafana UI:
```
http://localhost:4000/

username: admin
password: admin123
```

## Architecture

### Backend

### Edge

### Edge-Backend communication

### Sensors

## Documentation

### Alerting via SMS
Currently, the alerting service is configured to send SMS alerts to a predefined phone number via an SMS API.  
The service is triggered when the telemetry analyser service detects an anomaly in the telemetry data, or when receiving an alert from the edge. 
The alerting service uses the `Free SMS API` to send SMS alerts.

If you want to use the SMS alerting service, you need to provide the following environment variables, for example via a `.env` file located in the `~/backend/services/gsm-gateway` directory:
- `FREE_SMS_API_USER`: The username for the Free SMS API
- `FREE_SMS_API_PASS`: The password for the Free SMS API

---

### Telemetry client service API for Edge simulation

This API simulates sensor data normally published by the edge devices. When used, it will publish messages on the same topic that would be used by the edge device, simulating real telemetry data. The simulation allows testing and monitoring of data flow through RabbitMQ to the backend.

| **Endpoint**                         | **Method** | **Description**                                                                                                   | **Request Body**                                                                                                            |
|--------------------------------------|------------|-------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `/api/telemetry/send`                | `POST`     | Simulates a single sensor data entry with a timestamp, `edgeId`, `deviceId`, `measurement`, and `value`.         | ``` { "timestamp": "{{$isoTimestamp}}", "edgeId": "edge-001", "deviceId": "device-001", "measurement": "temperature", "value": 30.5 } ``` |
| `/{edgeId}/{deviceId}/start`         | `POST`     | Starts a continuous simulation of sensor data for the specified `edgeId` and `deviceId`.                         | None                                                                                                                        |
| `/{edgeId}/{deviceId}/stop`          | `POST`     | Stops the continuous simulation of sensor data for the specified `edgeId` and `deviceId`.                        | None                                                                                                                        |

**Notes**:
- **Simulation Trigger**: When these endpoints are called, they will simulate the behavior of an edge device by sending messages on the expected topic.
- **Message Flow**: The data sent through these endpoints will be forwarded via the RabbitMQ broker, making it accessible to the backend service for further processing.

---

## Risk analysis

Voici un exemple de matrice de risque au format README. Cette matrice peut √™tre utile pour identifier, √©valuer et prioriser les risques en fonction de leur probabilit√© et de leur impact.

---

# Matrice de Risque

Voici la matrice de risques sur les principaux probl√®mes que nous avons identifi√©s. Pour rappel, les risques ssont class√©s en fonction de leur **probabilit√©** et de leur **impact**. 

---

|                  | **Impact Faible** | **Impact Mod√©r√©** | **Impact Important** | **Impact Grave**       | **Impact Catastrophique**       |
|------------------|-------------------|--------------------|-----------------------|-------------------------|----------------------------------|
| **Probabilit√© Tr√®s Faible** |               |                     |                        |                         |                                  |
| **Probabilit√© Faible**      |               |                     |üü° **R7** (Intrusion AMQP/MQTT) | üü† **R9** (Saturation stockage SQLite) |                                  |
| **Probabilit√© Moyenne**     |               |üü† **R6** (Mauvaise configuration des agents) | üü† **R3** (Fiabilit√© capteurs IoT) | üî¥**R5** (Panne Stream Processing) -  üî¥**R4** (Performances Raspberry Pi)  | üî¥**R8** (Panne RabbitMQ)           |
| **Probabilit√© √âlev√©e**      |               |  |  | üî¥**R2** (Indisponibilit√© des Services) | üî¥**R1** (S√©curit√© des donn√©es)      |

---

## L√©gende des couleurs

- üîµ **Faible** : Risque mineur, n√©cessite peu ou pas de mesures d'att√©nuation.
- üü° **Mod√©r√©** : Risque mod√©r√©, surveill√© et g√©r√© si n√©cessaire.
- üü† **Significatif** : Risque important, actions d'att√©nuation √† consid√©rer.
- üî¥ **Critique** : Risque majeur, n√©cessite des mesures imm√©diates et des plans de gestion.


---
1. **Risque de s√©curit√© des donn√©es (R1)**
   - Ce risque est critique en raison de la nature sensible des donn√©es m√©dicales √©chang√©es. Une fuite de ces informations pourrait avoir des r√©percussions √©normes. √âtant donn√© le nombre d'interm√©diaire parmis lequel circule ces donn√©es ainsi que la nature de ces donn√©es. Ce risque est class√© comme "Important" et "Catastrophique" il est donc primordial de s√©curiser ces donn√©es.

2. **Risque d‚Äôindisponibilit√© de certains services (R2)**
   - La perte de connectivit√© √† certains services est aussi un risque √† prendre en compte, notre syst√®me utilisant √©norm√©ment de micro-services, il est important de bien g√©rer pour chaucun les cas il n'y aura plus de contact avec l'exterieur. La probabilit√© de ce risque est √©lev√©e, et l'impact est grave car il interromprait le fonctionnement normal du syst√®me. Quand bien m√™me des syst√®mes de fonctionnement offline soient mis en placess, leurs fonctionnement resterait limit√©.

3. **Risque de fiabilit√© des capteurs IoT (R3)**
   - Les capteurs qui sont pr√©sents dans les domiciles que elderspy mets √† disposition, bien que tr√®s performants peuvent tomber en panne ou se d√©connecter. L'impact peut varier (en fonction du type de capteur) nous placerons ici le risque le plus √©lev√© parmis tous ces capteurs : Important. En effet, certains capteurs peuvent tomber en panne sans grande incidence pour le patient (Temperature de l'environnement / Qualit√© de l'air int√©rieur). Cependant, certains capteurs surveillant les constantes vitales du patient se doivent d'avoir une disponibilit√© constante. La moindre d√©connexion peut mener √† une perte importante de donn√©es (manque de donn√©es pour reconnaitre des patterns sur les mod√®les de maladies cardiaques par exemple)

4. **Risque de performances du Raspberry Pi (R4)**
   - Le Raspberry Pi est la passerelle principale, en fonction du nombre d'appareils √† traiter, des probl√®mes de performance et, entre autre de surchauffe peuvent survenirs. Cela conduirait √† une indisponibilit√© temporaire de la gateway, ce qui serait grave.

5. **Risque de panne du service de date processing (R5)**
   - Le service de traitement de flux est critique pour l‚Äôanalyse en temps r√©el. Sa panne ralentirait le traitement et pourrait emp√™cher la d√©tection d‚Äô√©v√©nements. La probabilit√© est moyenne, car bien que le Raspberry Pi soit limit√© en ressources, des red√©marrages automatiques et des protections peuvent limiter les interruptions.

6. **Risque de Mauvaise configuration des diff√©rents agents (R6)**
   - La mauvaise configuration des agents peut causer des probl√®mes temporaires, mais les effets sont en g√©n√©ral r√©cup√©rables avec des ajustements ou un red√©marrage. La probabilit√© est moyenne en raison de la complexit√© des configurations requises pour l'int√©gration de divers services.

7. **Risque d‚Äôintrusion via les services AMQP et MQTT (R7)**
   - Bien que ce risque ait un impact important, la probabilit√© d'une intrusion est r√©duite si les bonnes pratiques de s√©curit√© (chiffrement et authentification) sont appliqu√©es.

8. **Risque de panne du RabbitMQ ou des services de messagerie (R8)**
   - RabbitMQ est central dans cette architecture pour la gestion des messages, et sa non-disponibilit√©e causerait des perturbations majeures. La probabilit√© est moyenne, car bien que RabbitMQ soit fiable, il peut √™tre soumis √† des interruptions si la charge est √©lev√©e ou si une maintenance non planifi√©e se produit.

9. **Risque de manque de capacit√© de stockage (SQLite sur le Pi) (R9)**
    - La saturation du stockage SQLite est possible si les donn√©es ne sont pas r√©guli√®rement archiv√©es ou supprim√©es, ou encore, si un acc√®s √† Internet coup√© de mani√®re trop prolong√©. Bien que l'impact soit grave (perte de donn√©es), la probabilit√© est faible si un syst√®me de gestion de donn√©es efficace est mis en place. M√™me en cas de coupure d'acc√®s internet, le syst√®me doit √™tre en parfaite capacit√© de fonctionner de mani√®re autonome.


---

## Code structure

```plaintext
elderspy/
‚îú‚îÄ‚îÄ backend/                               # Backend services and configurations
‚îÇ   ‚îú‚îÄ‚îÄ grafana-provisioning/               # Grafana dashboard provisioning configurations and data sources (InfluxDB)
‚îÇ   ‚îú‚îÄ‚îÄ kubernetes/                         # Kubernetes deployment configurations and manifests resources
‚îÇ   ‚îú‚îÄ‚îÄ rabbitmq/                           # RabbitMQ configurations (plugins)
‚îÇ   ‚îú‚îÄ‚îÄ services/                           # Microservices of the backend
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/                          # Shared modules and utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alerting-service/                # Service for alert notifications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gsm-gateway/                     # GSM gateway service for GSM communication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telemetry-analyser-service/      # Analyzes telemetry data
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telemetry-client/                # Client for sending telemetry data
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telemetry-ingestion-service/     # Service to handle telemetry data ingestion
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml                  # Docker Compose file to run the backend services, InfluxDB, RabbitMQ and Grafana
‚îú‚îÄ‚îÄ gateway/                                # Gateway-related components (Edge)
‚îÇ   ‚îú‚îÄ‚îÄ include/                             # Header files and other inclusions
‚îÇ   ‚îú‚îÄ‚îÄ src/                                 # Source code for the gateway
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alert/                            # Alert handling logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mqtt-clients/                     # MQTT clients for message communication
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/                           # Configuration files for sensors
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml                   # Docker Compose file for gateway services
‚îú‚îÄ‚îÄ sensors/                                # Sensor-related configurations
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                           # Docker setup for the sensor module
‚îÇ   ‚îî‚îÄ‚îÄ flows.json                           # Node-RED flow for the sensor module
‚îî‚îÄ‚îÄ README.md                               # Main project documentation file
```

## How to contribute

We welcome contributions to the **elderspy** project! Here‚Äôs how you can get involved:

### 1. Fork the Repository
- Start by forking the repository to your own GitHub account.

### 2. Clone the Repository
- Clone your forked repository to your local machine:
```bash
git clone https://github.com/your-username/elderspy.git
```

### 3. Set Up the Environment
- Ensure you have the necessary dependencies installed, including Docker and any specific tools listed in the README.md.

### 4. Make Changes
- Make your changes to the codebase. Ensure that your changes are in line with the project‚Äôs guidelines and coding standards.
- Test your changes locally to ensure they function as expected.
- Add tests for your changes if applicable.
- Update the documentation to reflect your changes if necessary.
- Commit your changes and push them to your forked repository.

### 5. Create a Pull Request
- Create a pull request to the main repository.
- Ensure your pull request description clearly explains the changes you‚Äôve made and the reason for the changes.

### 6. Review and Collaborate
- Participate in the code review process by responding to feedback and making any necessary changes to your pull request.
